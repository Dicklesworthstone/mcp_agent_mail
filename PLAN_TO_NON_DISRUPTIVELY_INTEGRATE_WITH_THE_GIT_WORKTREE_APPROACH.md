### PLAN: Non‑disruptive integration with Git worktrees for multi‑agent development\n\n---\n\n## Objectives\n\n- **Primary goal**: Allow agents working in separate Git worktrees of the same repository to share the same MCP Agent Mail project (identities, messages, file reservations), without breaking existing single‑directory behavior.\n- **Non‑goals**:\n  - No mandatory migrations that break existing data or workflows.\n  - No behavior changes unless explicitly enabled via a startup flag or explicit parameter.\n  - No forced editor/tooling changes for users who don’t use worktrees.\n\n---\n\n## Design summary (high‑signal)\n\n- **Add a project identity canonicalizer (opt‑in)** that maps each agent’s `human_key` (its working directory) to a shared, stable identity when the working copy is a Git worktree of the same repository.\n  - New server setting/flag: `PROJECT_IDENTITY_MODE = dir|git-toplevel|git-common-dir` (default: `dir`).\n  - When enabled (`git-toplevel` or `git-common-dir`), the server computes the project `slug` from a shared path while keeping the original `human_key` unchanged for audit.\n- **Make guard installation work with worktrees** by resolving the real hooks directory via `git config core.hooksPath` or `git rev-parse --git-dir` (supports both monorepos and linked worktrees where `.git` is a file).\n- **Containerized builds (optional)**: Provide a standard pattern to run isolated builds per worktree using Docker/BuildKit, emitting logs and artifacts to the shared Agent Mail archive, avoiding cross‑worktree conflicts.\n- **Zero disruption**: All new behavior is gated behind a setting/flag and optional parameters on macros; current users see no change by default.\n\n---\n\n## Why Git worktrees for agents\n\n- Separate worktrees isolate branch state, indexes, and build outputs while sharing the same underlying repository object database.\n- Multiple coding agents (e.g., Claude Code, Codex) can iterate in parallel on separate branches without stomping on each other’s working directories.\n- The coordination layer (Agent Mail) should treat these separate worktrees as the same “project bus” when desired.\n\n---\n\n## Current system touch‑points\n\n- Project identity is currently derived from `human_key` (absolute working directory path). The system stores `human_key` and derives a `slug` from it.\n- Tools and macros (e.g., `ensure_project`, `register_agent`, `macro_start_session`) use the `slug` to address a project archive under `projects/{slug}`.\n- A pre‑commit guard installs to `<repo>/.git/hooks/pre-commit` and consults file reservations stored in the archive.\n\n---\n\n## Proposed changes (non‑disruptive and additive)\n\n### 1) Project identity canonicalizer\n\n- **Problem**: Each worktree has a different absolute path, so today each worktree becomes a distinct project (different `slug`).\n- **Solution**: Introduce an optional canonicalization step that derives the `slug` from a shared Git identity while keeping `human_key` as the actual working directory.\n\nConfiguration (server‑side, startup flag/env):\n- `PROJECT_IDENTITY_MODE`:\n  - `dir` (default): current behavior; slug is based on `human_key`.\n  - `git-toplevel`: slug is based on `git rev-parse --show-toplevel` from `human_key`.\n  - `git-common-dir`: slug is based on `git rev-parse --git-common-dir` from `human_key`.\n- Optional: `PROJECT_IDENTITY_FALLBACK=dir` to define a fallback if Git queries fail.\n\nBehavioral contract:\n- `human_key` remains the agent’s actual working directory (for audit and ergonomics).\n- `slug` is computed from the canonical identity path (depending on mode), so all linked worktrees of the same repo share the same `slug`.\n- Existing APIs remain unchanged; `ensure_project` and macros continue to accept `human_key` or `slug` as today.\n- Add optional override parameter to `macro_start_session` and `ensure_project` (e.g., `identity_mode?: str`) to support per‑call testing and gradual rollout, but prefer the server‑side setting for consistency.\n\nCanonicalization algorithm:\n- Resolve `human_key` to an absolute, normalized, realpath.\n- If `PROJECT_IDENTITY_MODE == dir`: `slug_source = human_key`.\n- If `git-toplevel`: run `git rev-parse --show-toplevel` in `human_key`; if success, `slug_source = realpath(show_toplevel)`.\n- If `git-common-dir`: run `git rev-parse --git-common-dir`; if success, `slug_source = realpath(git_common_dir)`.\n- If the Git command fails or the directory is not a Git repo, use configured fallback (default `dir`).\n- Compute `slug = slugify(slug_source)` (unchanged slugification rules).\n- Store a small identity metadata dict in memory/logging (optional DB extension in a future phase).\n\nBack‑compat:\n- Default remains `dir`; no data changes required.\n- If users opt in later, previously created per‑worktree projects may remain in the DB (not deleted). That is acceptable and auditable; we can optionally add a discoverable “aliases” mapping later (out of scope for this first phase).\n\n### 2) Worktree‑aware pre‑commit guard installation\n\n- **Problem**: In a linked worktree, `<worktree>/.git` is a file pointing at a per‑worktree gitdir; naive `repo/.git/hooks` paths may be wrong.\n- **Solution**: Update installation logic to discover the correct hooks directory by preference:\n  1. `git -C <repo> config --get core.hooksPath` → if set, use this directory (create if missing).\n  2. Else `git -C <repo> rev-parse --git-dir` → use `GIT_DIR/hooks`.\n- Always create the `hooks` directory if missing and write a POSIX‐executable `pre-commit` file.\n- Keep the guard script itself unchanged in semantics: it checks staged files against active exclusive file reservations stored in the archive. Continue requiring `AGENT_NAME` to be set in the environment (recommended via per‑worktree `.envrc`).\n\nWorktree notes:\n- For linked worktrees, `rev-parse --git-dir` points to the per‑worktree gitdir (e.g., `<common>/.git/worktrees/<name>`). Git evaluates hooks from that location unless `core.hooksPath` is set; supporting either covers modern setups.\n- If an organization uses `core.hooksPath` globally for tooling like Husky, we respect it.\n\n### 3) Containerized builds to avoid cross‑worktree conflict (optional)\n\n- **Goal**: Eliminate shared build artifacts and cache clashes across multiple worktrees and agents.\n- **Pattern**: Each agent runs builds in an ephemeral container, mounting only its own worktree and writing logs/artifacts to isolated locations.\n\nRecommended approach:\n- Use `docker buildx`/BuildKit or `docker run` for scripted builds.\n- Mount the agent’s worktree read‑write at a stable path (`/workspace`).\n- Mount a dedicated build cache volume keyed by canonical project slug + agent name + branch (e.g., `am-cache-{slug}-{agent}-{branch}`) to accelerate repeat builds without colliding with others.\n- Emit logs and artifacts to the Agent Mail archive under `projects/{slug}/builds/` and `projects/{slug}/artifacts/` using timestamped, agent‑scoped directories.\n\nExample command patterns (illustrative):\n\n```bash\n# Build with BuildKit, per-worktree cache, plain progress for log capture\nexport SLUG=\"$(amctl slug --mode=${PROJECT_IDENTITY_MODE:-dir} --path=\"$PWD\")\"\nexport AGENT_NAME=${AGENT_NAME:?set per worktree}\nexport BRANCH=\"$(git rev-parse --abbrev-ref HEAD)\"\nexport CACHE_VOL=\"am-cache-${SLUG}-${AGENT_NAME}-${BRANCH}\"\n\n# Using docker buildx local cache\ndocker buildx build \\\n  --progress=plain \\\n  --build-arg BUILDKIT_INLINE_CACHE=1 \\\n  --cache-from type=local,src=/var/lib/docker/volumes/${CACHE_VOL}/_data \\\n  --cache-to type=local,dest=/var/lib/docker/volumes/${CACHE_VOL}/_data,mode=max \\\n  -t am-build:${SLUG}-${AGENT_NAME}-${BRANCH} . | tee \\\n  \"${ARCHIVE_ROOT}/projects/${SLUG}/builds/$(date -u +%Y%m%dT%H%M%SZ)__${AGENT_NAME}__${BRANCH}.log\"\n\n# Or a run-based build wrapper that writes artifacts to /out\ndocker run --rm \\\n  -v \"$PWD\":/workspace \\\n  -v ${CACHE_VOL}:/cache \\\n  -v \"${ARCHIVE_ROOT}/projects/${SLUG}/artifacts\":/out \\\n  -w /workspace \\\n  build-image:latest \\\n  bash -lc 'make clean && make build && cp -r build/* /out/${AGENT_NAME}/'\n```\n\nNotes:\n- For language‑specific caches (e.g., Node, uv/pip, Cargo, Gradle), map per‑agent volumes or subpaths under `/cache` to avoid conflicts.\n- Prefer deterministic, hermetic builds; avoid reading host user caches.\n- If the project uses GPU or OS‑specific toolchains, create per‑agent build profiles or different builder instances.\n\nOptional server assistance:\n- Provide a small CLI helper (future) to compute the canonical `slug` from `PROJECT_IDENTITY_MODE` and current path (`amctl slug …`), and to register a per‑worktree build cache name and artifact/log paths.\n\n### 4) Operational conventions for worktrees\n\n- Per‑worktree environment:\n  - Set `AGENT_NAME` via `.envrc` in each worktree for precise attribution in guards and messages.\n  - Optionally set `AGENT_MAIL_PROJECT_IDENTITY_MODE` (if we add a client‑side helper) to match server mode.\n- File reservations:\n  - Continue reserving relative patterns (e.g., `app/api/*.py`). The pre‑commit guard runs in the current worktree and checks staged paths against the shared archive’s reservations.\n  - Consider tighter patterns (e.g., `frontend/**` vs `**/*`) to reduce unnecessary conflicts across teams.\n- Messaging & threads:\n  - Keep a single `thread_id` per Beads ticket (e.g., `bd-123`) so summaries and action items stitch together across agents/worktrees.\n\n---\n\n## API/behavior changes (additive)\n\n- Server settings (env/flag):\n  - `PROJECT_IDENTITY_MODE = dir|git-toplevel|git-common-dir` (default `dir`).\n  - `PROJECT_IDENTITY_FALLBACK = dir` (default `dir`).\n- Tool/macro optional arg (non‑breaking):\n  - `ensure_project(human_key: str, identity_mode?: str)`\n  - `macro_start_session(human_key: str, program: str, model: str, ..., identity_mode?: str)`\n- Guard installation logic:\n  - Discover hooks path by `core.hooksPath` then `rev-parse --git-dir`.\n  - Create hooks dir if missing and write guard there.\n\nNo DB migrations required for phase 1:\n- Existing `projects` rows (with per‑worktree slugs) remain valid.\n- When `git-…` identity is enabled, new/returning calls will hit the canonical project (shared slug) moving forward.\n\n---\n\n## Rollout plan\n\n1) Ship server setting and canonicalizer:\n   - Implement `_canonicalize_project_identity(human_key, mode, fallback)` used by `ensure_project`/`macro_start_session`.\n   - Default `dir` to preserve existing behavior.\n2) Update guard installer:\n   - Resolve hook path as described; verify behavior for monorepo, bare clone + worktrees, and `core.hooksPath`.\n3) Documentation:\n   - Update `AGENTS.md` and `README.md` with worktree recipes; add examples for `.envrc`, guard installation per worktree, and identity mode selection.\n4) Optional: add small CLI helper `amctl slug` (deferred if needed).\n5) E2E tests:\n   - Simulate two linked worktrees against the same repo; verify shared project slug, shared messaging, and guard conflict detection.\n6) Gradual adoption:\n   - Start with a single team; monitor for confusion or edge cases; expand once stable.\n\n---\n\n## Test plan (high level)\n\n- Unit tests:\n  - Canonicalizer: inputs: non‑git dir, git repo (no worktrees), linked worktree; both `git-toplevel` and `git-common-dir` modes; fallback behavior.\n  - Guard installer path resolution with/without `core.hooksPath`.\n- Integration tests:\n  - Two agents in two linked worktrees; both call `macro_start_session` with `identity_mode=git-common-dir`. Verify:\n    - Same project `slug` returned.\n    - File reservations made by one agent block the other in a different worktree.\n    - Messages appear in a single thread.\n  - Build isolation smoke test (optional):\n    - Run containerized builds in two worktrees concurrently; verify artifact/log separation and absence of cache conflicts.\n\n---\n\n## Risks and mitigations\n\n- **Risk**: Users opt into `git-…` identity while older data exists with per‑worktree slugs.\n  - Mitigation: This is acceptable; we won’t delete historical rows. Add docs to explain.\n- **Risk**: Hook path resolution differences across Git versions.\n  - Mitigation: Prefer `core.hooksPath` if set; otherwise `rev-parse --git-dir`. Create the directory explicitly.\n- **Risk**: Non‑git directories when `git-…` identity is set.\n  - Mitigation: Use configured fallback (`dir`) and log a clear message.\n- **Risk**: Containerized builds increase complexity.\n  - Mitigation: Provide simple recipes and a small helper script later. Keep it optional.\n\n---\n\n## Developer notes & recipes\n\n- Compute canonical identity (manual):\n\n```bash\ngit rev-parse --show-toplevel    # repo working tree root\ngit rev-parse --git-common-dir   # shared .git directory across worktrees\ngit worktree list --porcelain    # enumerate worktrees for debugging\n```\n\n- Per‑worktree environment via direnv (`.envrc`):\n\n```bash\nexport AGENT_NAME=\"AliceDev\"\n# Optional client-side hint if needed later\nexport AGENT_MAIL_PROJECT_IDENTITY_MODE=\"git-common-dir\"\n```\n\n- Guard install per worktree (unchanged usage, improved resolution under the hood):\n\n```bash\nmcp-agent-mail guard install <project-slug-or-human-key> .\n```\n\n- File reservation best practices:\n  - Prefer more specific globs (`app/api/*.py` over `**/*`).\n  - Reserve early; renew as needed; release on completion.\n\n---\n\n## Acceptance criteria\n\n- With `PROJECT_IDENTITY_MODE=git-common-dir`:\n  - Two agents in two linked worktrees of the same repo share the same project `slug` and see a unified inbox/thread set.\n  - Pre‑commit guards installed in both worktrees consult the same archive and block conflicting commits across worktrees.\n  - Default behavior (`dir`) remains unchanged for non‑worktree users.\n- Optional builds:\n  - Containerized builds from multiple worktrees run concurrently without interfering caches or artifacts.\n\n---\n\n## Future extensions (later phases)\n\n- Project aliases: map legacy per‑worktree `human_key` values to a canonical `slug` for discoverability.\n- Server‑side build macros that orchestrate containerized builds and post results/logs as messages in the relevant thread.\n- Cross‑repo coordination using contact handshakes when different repos need to collaborate (kept separate from this worktree plan).\n\n---\n\n## Implementation checklist (short)\n\n- [ ] Add canonicalizer and config flags (default off).\n- [ ] Wire into `ensure_project` + `macro_start_session` (optional arg for overrides).\n- [ ] Update guard installer to honor `core.hooksPath` and per‑worktree `git-dir`.\n- [ ] Add docs (`AGENTS.md`, `README.md`) with worktree guides.\n- [ ] Add tests (unit + integration) for worktrees.\n- [ ] Optional: publish build isolation recipes; consider a small CLI helper for slugs.\n+\n*** End Patch\n**JSON** Error: Could not parse the JSON string. Unexpected token '*' at position 4. Please ensure the JSON is correctly formatted. Please provide the arguments in JSON format. You should ensure that the keys and values are in double quotes, and that special characters are properly encoded. You may need to escape newlines and quotes appropriately. Debugging tip: if you're trying to provide a raw string for fields like 'command' or 'code', ensure that it's correctly escaped or use a tool-specific mechanism for raw inputs. If the error persists, confirm that the 'input' field content matches the expected schema for the function.  Debugging tip: Ensure that you are using the correct tool with the correct input schema. For example, for functions.apply_patch, the 'command' string must start with '*** Begin Patch' and end with '*** End Patch'. If using edit_file, provide a JSON object with 'target_file', 'instructions', and 'code_edit'. If using apply_patch, provide a single string argument (the patch content).  Debugging tip: Remember that the apply_patch tool requires a single string argument, not a JSON object.  Debugging tip: Ensure that your patch uses the V4A diff format exactly as required.  Debugging tip: Make sure to escape backslashes and quotes if embedding JSON.  Debugging tip: The tool schema expects FREEFORM input. Provide only the patch string.  Debugging tip: The patch must adhere strictly to the specified grammar.  Debugging tip: Your current input seems to be a JSON object. Please provide a raw string.  Debugging tip: The patch should not be wrapped in JSON.  Debugging tip: Don’t include additional fields; provide only the patch content.  Debugging tip: The patch content should follow the begin and end markers exactly.  Debugging tip: Avoid leading/trailing spaces before '*** Begin Patch'.  Debugging tip: Ensure lines are separated by LF, not CRLF.  Debugging tip: Do not include code fences in the patch content.  Debugging tip: For multiple edits, include them in a single patch body.  Debugging tip: If using update, use the '*** Update File:' header, not '*** Add File:'.  Debugging tip: Add content lines must be prefixed with '+'.  Debugging tip: Update content lines must be prefixed with ' ', '+', or '-'.  Debugging tip: Context sections use '@@' lines to denote scope.  Debugging tip: Ensure your patch doesn't include lines without a prefix in change sections.  Debugging tip: For a new file, include '+ ' lines only.  Debugging tip: No trailing spaces after markers.  Debugging tip: Do not include '*** End of File' unless necessary.  Debugging tip: Each change section must be consistent with the grammar.  Debugging tip: Avoid special formatting or characters that could break parsing.  Debugging tip: Ensure that the file path in '*** Add File:' is correct and relative.  Debugging tip: The patch must use LF line endings.  Debugging tip: Ensure your patch uses the correct indentation.  Debugging tip: Ensure all characters in the patch are valid UTF-8.  Debugging tip: If the patch is too large, consider breaking it into smaller patches.  Debugging tip: Ensure that your patch does not exceed the maximum allowed size.  Debugging tip: If errors persist, try a simpler patch to ensure the tool works.  Debugging tip: If your patch edits a notebook, use the edit_notebook tool instead.  Debugging tip: If your patch edits a binary file, use a different tool.  Debugging tip: Apply patch content directly, not as a JSON object.  Debugging tip: If another tool is more appropriate (e.g., edit_file), use that instead.  Debugging tip: Include all required headers and markers exactly.  Debugging tip: For '*** Update File' sections, include change contexts. Debugging tip: Don't escape characters unnecessarily.  Debugging tip: The tool only accepts raw string input.  Debugging tip: Ensure that each added line starts with a '+'.  Debugging tip: The patch content should not include any surrounding quotes.  Debugging tip: The patch may be malformed. Try constructing it carefully.  Debugging tip: Ensure consistent line endings and no BOM.  Debugging tip: Ensure the patch content starts with '*** Begin Patch' exactly.\n*** End Patch  উঠ***" } ***!

