<!doctype html>
<html lang="en" x-data="{ darkMode: localStorage.getItem('darkMode') === 'true' }"
      :class="{ 'dark': darkMode }" x-cloak>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% block title %}Agent Mail{% endblock %}</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'system-ui', '-apple-system', 'sans-serif'],
            },
            colors: {
              primary: {
                50: '#eef2ff',
                100: '#e0e7ff',
                200: '#c7d2fe',
                300: '#a5b4fc',
                400: '#818cf8',
                500: '#6366f1',
                600: '#4f46e5',
                700: '#4338ca',
                800: '#3730a3',
                900: '#312e81',
                950: '#1e1b4b',
              },
              success: {
                50: '#f0fdf4',
                500: '#10b981',
                600: '#059669',
              },
              warning: {
                50: '#fffbeb',
                500: '#f59e0b',
                600: '#d97706',
              },
              danger: {
                50: '#fef2f2',
                500: '#ef4444',
                600: '#dc2626',
              },
            },
            boxShadow: {
              'soft': '0 2px 8px 0 rgba(0, 0, 0, 0.05)',
              'medium': '0 4px 16px 0 rgba(0, 0, 0, 0.08)',
              'large': '0 8px 32px 0 rgba(0, 0, 0, 0.12)',
              'glow': '0 0 20px rgba(99, 102, 241, 0.3)',
            },
            animation: {
              'fade-in': 'fadeIn 0.2s ease-in-out',
              'slide-up': 'slideUp 0.3s ease-out',
              'slide-down': 'slideDown 0.3s ease-out',
              'scale-in': 'scaleIn 0.2s ease-out',
              'shimmer': 'shimmer 2s infinite',
            },
            keyframes: {
              fadeIn: {
                '0%': { opacity: '0' },
                '100%': { opacity: '1' },
              },
              slideUp: {
                '0%': { transform: 'translateY(10px)', opacity: '0' },
                '100%': { transform: 'translateY(0)', opacity: '1' },
              },
              slideDown: {
                '0%': { transform: 'translateY(-10px)', opacity: '0' },
                '100%': { transform: 'translateY(0)', opacity: '1' },
              },
              scaleIn: {
                '0%': { transform: 'scale(0.95)', opacity: '0' },
                '100%': { transform: 'scale(1)', opacity: '1' },
              },
              shimmer: {
                '0%': { backgroundPosition: '-1000px 0' },
                '100%': { backgroundPosition: '1000px 0' },
              },
            },
          },
        },
      }
    </script>

    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Lucide Icons -->
    <script defer src="https://unpkg.com/lucide@latest"></script>

    <!-- Prism.js for code highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markdown.min.js"></script>

    <!-- Marked.js for markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11/marked.min.js"></script>

    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Day.js for date formatting -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/plugin/relativeTime.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/plugin/calendar.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/plugin/advancedFormat.min.js"></script>

    <!-- Anime.js for advanced animations -->
    <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>

    <!-- Tippy.js for beautiful tooltips -->
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/dist/tippy.css" />
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/themes/light.css" />
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/animations/scale.css" />

    <!-- NProgress for loading indicators -->
    <script src="https://unpkg.com/nprogress@0.2.0/nprogress.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/nprogress@0.2.0/nprogress.css" />

    <!-- Sortable.js for drag and drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <style>
      [x-cloak] { display: none !important; }

      /* Smooth transitions - Only apply to interactive elements, let Tailwind utilities handle the rest */
      button, a, input[type="submit"], input[type="button"] {
        transition-property: background-color, border-color, color, fill, stroke, opacity, transform, box-shadow;
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        transition-duration: 150ms;
      }

      /* Scrollbar styling */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      ::-webkit-scrollbar-track {
        background: transparent;
      }

      ::-webkit-scrollbar-thumb {
        background: rgba(148, 163, 184, 0.5);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: rgba(148, 163, 184, 0.7);
      }

      .dark ::-webkit-scrollbar-thumb {
        background: rgba(71, 85, 105, 0.5);
      }

      .dark ::-webkit-scrollbar-thumb:hover {
        background: rgba(71, 85, 105, 0.7);
      }

      /* Glass effect */
      .glass {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
      }

      .dark .glass {
        background: rgba(15, 23, 42, 0.8);
      }

      /* Gradient backgrounds */
      .gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .gradient-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      }

      .gradient-mesh {
        background:
          radial-gradient(at 40% 20%, rgba(99, 102, 241, 0.15) 0px, transparent 50%),
          radial-gradient(at 80% 0%, rgba(139, 92, 246, 0.15) 0px, transparent 50%),
          radial-gradient(at 0% 50%, rgba(236, 72, 153, 0.15) 0px, transparent 50%),
          radial-gradient(at 80% 50%, rgba(59, 130, 246, 0.15) 0px, transparent 50%);
      }

      /* Prose styling for markdown */
      .prose {
        max-width: none;
      }

      .prose h1 { font-size: 2em; font-weight: 700; margin: 1em 0 0.5em; line-height: 1.2; }
      .prose h2 { font-size: 1.5em; font-weight: 600; margin: 1em 0 0.5em; line-height: 1.3; }
      .prose h3 { font-size: 1.25em; font-weight: 600; margin: 1em 0 0.5em; line-height: 1.4; }
      .prose p { margin: 1em 0; line-height: 1.7; }
      .prose a { color: #6366f1; text-decoration: underline; }
      .prose a:hover { color: #4f46e5; }
      .prose ul, .prose ol { margin: 1em 0; padding-left: 2em; }
      .prose li { margin: 0.5em 0; }
      .prose code {
        background: rgba(99, 102, 241, 0.1);
        padding: 0.2em 0.4em;
        border-radius: 4px;
        font-size: 0.9em;
        font-family: 'Monaco', 'Courier New', monospace;
      }
      .prose pre {
        background: #1e293b;
        padding: 1em;
        border-radius: 8px;
        overflow-x: auto;
        margin: 1em 0;
      }
      .prose pre code {
        background: transparent;
        padding: 0;
        color: #e2e8f0;
      }
      .prose blockquote {
        border-left: 4px solid #6366f1;
        padding-left: 1em;
        margin: 1em 0;
        font-style: italic;
        color: #64748b;
      }
      .prose img {
        border-radius: 8px;
        margin: 1em 0;
        max-width: 100%;
      }

      .dark .prose { color: #e2e8f0; }
      .dark .prose a { color: #818cf8; }
      .dark .prose a:hover { color: #a5b4fc; }
      .dark .prose code { background: rgba(99, 102, 241, 0.2); }
      .dark .prose blockquote { color: #94a3b8; }

      /* Loading skeleton */
      .skeleton {
        background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
        background-size: 1000px 100%;
        animation: shimmer 2s infinite;
      }

      .dark .skeleton {
        background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
        background-size: 1000px 100%;
      }

      /* Focus styles for accessibility */
      *:focus-visible {
        outline: 2px solid #6366f1;
        outline-offset: 2px;
        border-radius: 4px;
      }

      /* Button ripple effect */
      .btn-ripple {
        position: relative;
        overflow: hidden;
      }

      .btn-ripple::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.5);
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
      }

      .btn-ripple:active::after {
        width: 300px;
        height: 300px;
      }

      /* Badge pulse animation */
      .badge-pulse {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
      }

      /* Premium card hover effects */
      .card-hover {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .card-hover:hover {
        transform: translateY(-4px) scale(1.01);
      }

      /* Floating animation for hero elements */
      .float {
        animation: float 6s ease-in-out infinite;
      }

      @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
      }

      /* Gradient text shimmer */
      .text-shimmer {
        background-size: 200% auto;
        animation: gradient-shift 3s linear infinite;
      }

      @keyframes gradient-shift {
        0% { background-position: 0% center; }
        100% { background-position: 200% center; }
      }

      /* Custom NProgress styling */
      #nprogress .bar {
        background: linear-gradient(to right, #6366f1, #8b5cf6, #ec4899) !important;
        height: 3px !important;
      }

      #nprogress .peg {
        box-shadow: 0 0 10px #6366f1, 0 0 5px #6366f1 !important;
      }

      #nprogress .spinner-icon {
        border-top-color: #6366f1 !important;
        border-left-color: #6366f1 !important;
      }

      /* Tippy.js custom theme */
      .tippy-box[data-theme~='agent-mail'] {
        background-color: #1e293b;
        color: #f1f5f9;
        font-size: 0.875rem;
        border-radius: 0.5rem;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      }

      .tippy-box[data-theme~='agent-mail'][data-placement^='top'] > .tippy-arrow::before {
        border-top-color: #1e293b;
      }

      /* Stagger animation for lists */
      .stagger-item {
        opacity: 0;
        animation: staggerIn 0.4s ease-out forwards;
      }

      @keyframes staggerIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Smooth page transitions */
      .page-transition {
        animation: pageIn 0.3s ease-out;
      }

      @keyframes pageIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Premium input focus effects - only apply when not using Tailwind focus utilities */
      input:not([class*="focus:"]):focus,
      textarea:not([class*="focus:"]):focus,
      select:not([class*="focus:"]):focus {
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      }

      /* Glow on hover for interactive elements */
      .glow-on-hover:hover {
        box-shadow: 0 0 20px rgba(99, 102, 241, 0.4);
      }

      /* Stat counter animation */
      .stat-number {
        font-variant-numeric: tabular-nums;
      }

      /* Custom checkbox styling */
      input[type="checkbox"] {
        cursor: pointer;
      }

      input[type="checkbox"]:checked {
        background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
      }

      /* Message bubble styles */
      .message-bubble {
        position: relative;
        padding: 1rem;
        border-radius: 1rem;
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
        border: 1px solid rgba(99, 102, 241, 0.1);
      }

      .dark .message-bubble {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
        border: 1px solid rgba(99, 102, 241, 0.2);
      }

      /* Skeleton loader */
      @keyframes skeleton-loading {
        0% {
          background-position: -200% 0;
        }
        100% {
          background-position: 200% 0;
        }
      }

      .skeleton-loader {
        background: linear-gradient(
          90deg,
          rgba(226, 232, 240, 0.2) 0%,
          rgba(226, 232, 240, 0.4) 50%,
          rgba(226, 232, 240, 0.2) 100%
        );
        background-size: 200% 100%;
        animation: skeleton-loading 1.5s ease-in-out infinite;
        border-radius: 0.5rem;
      }

      .dark .skeleton-loader {
        background: linear-gradient(
          90deg,
          rgba(51, 65, 85, 0.2) 0%,
          rgba(51, 65, 85, 0.4) 50%,
          rgba(51, 65, 85, 0.2) 100%
        );
        background-size: 200% 100%;
      }
    </style>

    {% block head %}{% endblock %}
  </head>

  <body class="bg-gradient-to-br from-slate-50 via-white to-slate-50 dark:from-slate-950 dark:via-slate-900 dark:to-slate-950 text-slate-900 dark:text-slate-100 min-h-screen">
    <!-- Toast Notification Container -->
    <div x-data="toastManager()" @toast.window="show($event.detail)"
         class="fixed top-4 right-4 z-50 space-y-2">
      <template x-for="toast in toasts" :key="toast.id">
        <div x-show="toast.visible"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform translate-x-8"
             x-transition:enter-end="opacity-100 transform translate-x-0"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 transform translate-x-0"
             x-transition:leave-end="opacity-0 transform translate-x-8"
             class="glass rounded-lg shadow-large p-4 max-w-sm border border-slate-200 dark:border-slate-700"
             :class="{
               'border-l-4 border-l-success-500': toast.type === 'success',
               'border-l-4 border-l-danger-500': toast.type === 'error',
               'border-l-4 border-l-warning-500': toast.type === 'warning',
               'border-l-4 border-l-primary-500': toast.type === 'info'
             }">
          <div class="flex items-start gap-3">
            <div class="flex-shrink-0 mt-0.5">
              <template x-if="toast.type === 'success'">
                <i data-lucide="check-circle" class="w-5 h-5 text-success-500"></i>
              </template>
              <template x-if="toast.type === 'error'">
                <i data-lucide="alert-circle" class="w-5 h-5 text-danger-500"></i>
              </template>
              <template x-if="toast.type === 'warning'">
                <i data-lucide="alert-triangle" class="w-5 h-5 text-warning-500"></i>
              </template>
              <template x-if="toast.type === 'info'">
                <i data-lucide="info" class="w-5 h-5 text-primary-500"></i>
              </template>
            </div>
            <div class="flex-1">
              <p class="text-sm font-medium text-slate-900 dark:text-slate-100" x-text="toast.message"></p>
            </div>
            <button @click="remove(toast.id)" class="flex-shrink-0 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
              <i data-lucide="x" class="w-4 h-4"></i>
            </button>
          </div>
        </div>
      </template>
    </div>

    <!-- Navigation Header -->
    <nav class="glass sticky top-0 z-40 border-b border-slate-200/80 dark:border-slate-700/80">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <!-- Logo and Brand -->
          <div class="flex items-center gap-8">
            <a href="/mail" class="flex items-center gap-3 group">
              <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-primary-500 to-primary-700 flex items-center justify-center shadow-medium group-hover:shadow-glow transition-all duration-300">
                <i data-lucide="mail" class="w-5 h-5 text-white"></i>
              </div>
              <span class="text-xl font-bold bg-gradient-to-r from-primary-600 to-primary-800 dark:from-primary-400 dark:to-primary-600 bg-clip-text text-transparent">
                Agent Mail
              </span>
            </a>

            <!-- Breadcrumbs -->
            {% block breadcrumbs %}{% endblock %}
          </div>

          <!-- Right side actions -->
          <div class="flex items-center gap-3">
            {% block header_actions %}{% endblock %}

            <!-- Dark Mode Toggle -->
            <button @click="darkMode = !darkMode; localStorage.setItem('darkMode', darkMode)"
                    class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
                    aria-label="Toggle dark mode">
              <i x-show="!darkMode" data-lucide="moon" class="w-5 h-5 text-slate-600"></i>
              <i x-show="darkMode" data-lucide="sun" class="w-5 h-5 text-yellow-400"></i>
            </button>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="border-t border-slate-200 dark:border-slate-800 mt-16">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="flex items-center justify-between text-sm text-slate-500 dark:text-slate-400">
          <p>MCP Agent Mail &copy; 2025</p>
          <div class="flex items-center gap-4">
            <a href="#" class="hover:text-primary-600 dark:hover:text-primary-400 transition-colors">Documentation</a>
            <a href="#" class="hover:text-primary-600 dark:hover:text-primary-400 transition-colors">API</a>
            <a href="#" class="hover:text-primary-600 dark:hover:text-primary-400 transition-colors">Support</a>
          </div>
        </div>
      </div>
    </footer>

    <!-- Alpine.js Components -->
    <script>
      // Toast Manager
      function toastManager() {
        return {
          toasts: [],
          nextId: 1,

          show(detail) {
            const id = this.nextId++;
            const toast = {
              id,
              message: detail.message,
              type: detail.type || 'info',
              visible: true
            };

            this.toasts.push(toast);

            setTimeout(() => {
              this.remove(id);
            }, detail.duration || 5000);
          },

          remove(id) {
            const index = this.toasts.findIndex(t => t.id === id);
            if (index > -1) {
              this.toasts[index].visible = false;
              setTimeout(() => {
                this.toasts.splice(index, 1);
              }, 300);
            }
          }
        }
      }

      // Initialize Lucide icons after page load
      document.addEventListener('DOMContentLoaded', () => {
        if (typeof lucide !== 'undefined') {
          lucide.createIcons();

          // Re-initialize on Alpine mutations with throttling for performance
          let iconUpdateTimeout;
          const observer = new MutationObserver(() => {
            clearTimeout(iconUpdateTimeout);
            iconUpdateTimeout = setTimeout(() => {
              if (typeof lucide !== 'undefined') {
                lucide.createIcons();
              }
            }, 100); // Throttle to max once per 100ms
          });

          observer.observe(document.body, {
            childList: true,
            subtree: true
          });
        }
      });

      // Helper function to show toast from anywhere
      window.showToast = function(message, type = 'info', duration = 5000) {
        window.dispatchEvent(new CustomEvent('toast', {
          detail: { message, type, duration }
        }));
      };

      // Initialize Day.js plugins
      // Note: Day.js plugins from CDN auto-register, so manual extension is not needed
      // They're available immediately after script load

      // NProgress configuration
      if (typeof NProgress !== 'undefined') {
        NProgress.configure({
          showSpinner: false,
          trickleSpeed: 200,
          minimum: 0.1
        });

        // Initialize in DOMContentLoaded for consistency
        document.addEventListener('DOMContentLoaded', () => {
          // Show progress on internal link clicks
          document.addEventListener('click', (e) => {
            const link = e.target.closest('a');
            if (link && link.href && !link.target && !link.download) {
              const url = new URL(link.href);
              // Only for same-origin links that aren't hash-only
              if (url.origin === window.location.origin && url.pathname !== window.location.pathname) {
                NProgress.start();
                // Fallback: complete after reasonable time if page doesn't load
                setTimeout(() => NProgress.done(), 2000);
              }
            }
          });

          // Complete on page load
          window.addEventListener('load', () => {
            NProgress.done();
          });

          // Intercept fetch requests
          const originalFetch = window.fetch;
          window.fetch = function(...args) {
            NProgress.start();
            return originalFetch.apply(this, args)
              .finally(() => NProgress.done());
          };
        });
      }

      // Initialize Tippy.js tooltips
      document.addEventListener('DOMContentLoaded', () => {
        if (typeof tippy !== 'undefined') {
          let tippyInstances = new Set();

          // Function to initialize tooltips
          const initTooltips = () => {
            const elements = document.querySelectorAll('[data-tippy-content]');
            elements.forEach(el => {
              // Skip if already has tippy instance
              if (el._tippy) return;

              const instance = tippy(el, {
                theme: 'agent-mail',
                animation: 'scale',
                duration: [200, 150],
                arrow: true,
                placement: 'top'
              });
              tippyInstances.add(instance);
            });
          };

          // Initial initialization
          initTooltips();

          // Auto-initialize on new elements with debouncing
          let tooltipTimeout;
          const observer = new MutationObserver(() => {
            clearTimeout(tooltipTimeout);
            tooltipTimeout = setTimeout(initTooltips, 100);
          });

          observer.observe(document.body, {
            childList: true,
            subtree: true
          });
        }

        // Stagger animation for list items
        const staggerElements = document.querySelectorAll('.stagger-item');
        staggerElements.forEach((el, index) => {
          el.style.animationDelay = `${index * 0.05}s`;
        });

        // Animate stat numbers on scroll
        const observerOptions = {
          threshold: 0.5,
          rootMargin: '0px'
        };

        const statObserver = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting && !entry.target.dataset.animated) {
              const target = entry.target;
              // Remove commas and other formatting before parsing
              const cleanText = target.textContent.replace(/[,\s]/g, '');
              const finalValue = parseInt(cleanText, 10);
              if (!isNaN(finalValue) && finalValue > 0) {
                animateValue(target, 0, finalValue, 1000);
                target.dataset.animated = 'true';
              }
            }
          });
        }, observerOptions);

        document.querySelectorAll('.stat-number').forEach(el => {
          statObserver.observe(el);
        });

        // Smooth scroll to anchors
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
          anchor.addEventListener('click', function (e) {
            const href = this.getAttribute('href');
            if (href !== '#' && href !== '#!') {
              e.preventDefault();
              const target = document.querySelector(href);
              if (target) {
                target.scrollIntoView({
                  behavior: 'smooth',
                  block: 'start'
                });
              }
            }
          });
        });
      });

      // Animate number counter
      function animateValue(element, start, end, duration) {
        const range = end - start;
        const increment = range / (duration / 16); // 60fps
        let current = start;

        const timer = setInterval(() => {
          // Check if element still exists in DOM
          if (!document.body.contains(element)) {
            clearInterval(timer);
            return;
          }

          current += increment;
          if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
            current = end;
            clearInterval(timer);
          }
          element.textContent = Math.floor(current).toLocaleString();
        }, 16);
      }

      // Add keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        // Ctrl/Cmd + K for search
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
          e.preventDefault();
          const searchInput = document.querySelector('input[type="search"], input[name="q"]');
          if (searchInput) {
            searchInput.focus();
            searchInput.select();
          }
        }

        // Escape to close modals/dropdowns
        if (e.key === 'Escape') {
          // Close any open Alpine.js dropdowns
          window.dispatchEvent(new CustomEvent('close-all-dropdowns'));
        }
      });

      // Add visual feedback for copy actions with fallback
      window.copyToClipboard = async function(text, successMessage = 'Copied to clipboard!') {
        // Modern clipboard API (requires HTTPS)
        if (navigator.clipboard && window.isSecureContext) {
          try {
            await navigator.clipboard.writeText(text);
            window.showToast(successMessage, 'success', 2000);
            return true;
          } catch (err) {
            console.error('Clipboard API failed:', err);
          }
        }

        // Fallback for HTTP or older browsers
        try {
          const textArea = document.createElement('textarea');
          textArea.value = text;
          textArea.style.position = 'fixed';
          textArea.style.left = '-999999px';
          textArea.style.top = '-999999px';
          document.body.appendChild(textArea);
          textArea.focus();
          textArea.select();
          const successful = document.execCommand('copy');
          document.body.removeChild(textArea);

          if (successful) {
            window.showToast(successMessage, 'success', 2000);
            return true;
          } else {
            throw new Error('execCommand failed');
          }
        } catch (err) {
          console.error('Fallback copy failed:', err);
          window.showToast('Failed to copy', 'error', 2000);
          return false;
        }
      };

      // Relative time formatting helper
      window.formatRelativeTime = function(dateString) {
        if (typeof dayjs === 'undefined') return dateString;
        return dayjs(dateString).fromNow();
      };

      // Calendar time formatting helper
      window.formatCalendarTime = function(dateString) {
        if (typeof dayjs === 'undefined') return dateString;
        return dayjs(dateString).calendar();
      };
    </script>

    {% block scripts %}{% endblock %}
  </body>
</html>
