{% extends "base.html" %}

{% block title %}Send Message â€” Human Overseer{% endblock %}

{% block breadcrumbs %}
<nav class="flex items-center gap-2 text-sm">
  <a href="/mail" class="text-slate-600 dark:text-slate-400 hover:text-primary-600 dark:hover:text-primary-400 transition-colors">
    Projects
  </a>
  <i data-lucide="chevron-right" class="w-4 h-4 text-slate-400"></i>
  <a href="/mail/{{ project.slug }}" class="text-slate-600 dark:text-slate-400 hover:text-primary-600 dark:hover:text-primary-400 transition-colors">
    {{ project.human_key }}
  </a>
  <i data-lucide="chevron-right" class="w-4 h-4 text-slate-400"></i>
  <span class="text-slate-900 dark:text-white font-medium">Send Message (Human Overseer)</span>
</nav>
{% endblock %}

{% block content %}
<div class="space-y-6 animate-fade-in" x-data="overseerComposer()">
  <!-- Header -->
  <div class="relative overflow-hidden bg-gradient-to-br from-white via-amber-50/30 to-orange-50/30 dark:from-slate-800 dark:via-slate-800/90 dark:to-slate-800 rounded-3xl p-10 shadow-large border border-slate-200/50 dark:border-slate-700/50">
    <!-- Decorative gradient blobs -->
    <div class="absolute top-0 right-0 w-64 h-64 bg-gradient-to-br from-amber-500/20 to-orange-500/20 rounded-full blur-3xl pointer-events-none"></div>
    <div class="absolute bottom-0 left-0 w-48 h-48 bg-gradient-to-tr from-red-500/10 to-yellow-500/10 rounded-full blur-3xl pointer-events-none"></div>

    <div class="relative flex items-start gap-6">
      <div class="w-20 h-20 bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl flex items-center justify-center shadow-large float">
        <i data-lucide="shield-alert" class="w-10 h-10 text-white"></i>
      </div>
      <div class="flex-1">
        <h1 class="text-4xl font-bold text-slate-900 dark:text-white mb-3">
          Send Message as Human Overseer
        </h1>
        <p class="text-lg text-slate-700 dark:text-slate-300 mb-4">
          Messages sent from this interface will be delivered to agents with <strong>high priority</strong> and include a preamble
          instructing them to prioritize your request over their current tasks.
        </p>
        <div class="flex items-start gap-2 p-4 bg-amber-100 dark:bg-amber-900/20 border border-amber-300 dark:border-amber-700 rounded-xl text-sm">
          <i data-lucide="alert-triangle" class="w-5 h-5 text-amber-700 dark:text-amber-400 flex-shrink-0 mt-0.5"></i>
          <div class="text-amber-900 dark:text-amber-100">
            <strong>Important:</strong> Human overseer messages bypass normal contact policies and are automatically marked as high importance.
            Agents are instructed to pause current work, complete your request, then resume their original plans.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Message Composer Form -->
  <form @submit.prevent="sendMessage()" class="space-y-6">
    <!-- Recipients Selection -->
    <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 shadow-soft border border-slate-200 dark:border-slate-700">
      <div class="flex items-center gap-3 mb-6">
        <div class="w-12 h-12 bg-gradient-to-br from-primary-500 to-primary-700 rounded-xl flex items-center justify-center shadow-medium">
          <i data-lucide="users" class="w-6 h-6 text-white"></i>
        </div>
        <div>
          <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Recipients</h2>
          <p class="text-sm text-slate-600 dark:text-slate-400">Select which agents should receive this message</p>
        </div>
      </div>

      <!-- Select All / None -->
      <div class="flex items-center justify-between mb-4 pb-4 border-b border-slate-200 dark:border-slate-700">
        <span class="text-sm font-medium text-slate-700 dark:text-slate-300">
          <span x-text="selectedRecipients.length"></span> of {{ agents|length }} agent{{ 's' if agents|length != 1 else '' }} selected
        </span>
        <div class="flex items-center gap-2">
          <button type="button" @click="selectAll()"
                  class="px-4 py-2 text-sm font-medium text-primary-700 dark:text-primary-400 hover:bg-primary-50 dark:hover:bg-primary-900/20 rounded-lg transition-colors">
            Select All
          </button>
          <button type="button" @click="selectNone()"
                  class="px-4 py-2 text-sm font-medium text-slate-700 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors">
            Clear
          </button>
        </div>
      </div>

      {% if agents %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
          {% for agent in agents %}
            <label class="flex items-center gap-3 p-4 bg-slate-50 dark:bg-slate-900 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl border-2 border-slate-200 dark:border-slate-700 hover:border-primary-400 dark:hover:border-primary-600 cursor-pointer transition-all duration-200 group">
              <input type="checkbox"
                     value="{{ agent.name }}"
                     x-model="selectedRecipients"
                     class="w-5 h-5 text-primary-600 bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded focus:ring-2 focus:ring-primary-500 transition-all duration-200 cursor-pointer" />
              <div class="flex items-center gap-2 flex-1 min-w-0">
                <div class="w-8 h-8 bg-gradient-to-br from-success-500 to-success-700 rounded-lg flex items-center justify-center flex-shrink-0">
                  <i data-lucide="bot" class="w-4 h-4 text-white"></i>
                </div>
                <span class="text-sm font-medium text-slate-900 dark:text-white truncate">{{ agent.name }}</span>
              </div>
            </label>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-center py-12 bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-700">
          <div class="w-16 h-16 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4">
            <i data-lucide="user-x" class="w-8 h-8 text-slate-400"></i>
          </div>
          <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-2">No Agents Registered</h3>
          <p class="text-sm text-slate-600 dark:text-slate-400">
            No agents are currently registered in this project. Agents must register before they can receive messages.
          </p>
        </div>
      {% endif %}
    </div>

    <!-- Message Details -->
    <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 shadow-soft border border-slate-200 dark:border-slate-700">
      <div class="flex items-center gap-3 mb-6">
        <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-700 rounded-xl flex items-center justify-center shadow-medium">
          <i data-lucide="file-text" class="w-6 h-6 text-white"></i>
        </div>
        <div>
          <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Message Content</h2>
          <p class="text-sm text-slate-600 dark:text-slate-400">Compose your message in GitHub-flavored Markdown</p>
        </div>
      </div>

      <!-- Subject -->
      <div class="mb-6">
        <label for="subject" class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">
          Subject Line <span class="text-danger-500">*</span>
        </label>
        <input type="text"
               id="subject"
               x-model="subject"
               required
               placeholder="e.g., Urgent: Pause current work and review security vulnerability"
               class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-900 border-2 border-slate-200 dark:border-slate-700 focus:border-primary-500 dark:focus:border-primary-500 rounded-xl text-slate-900 dark:text-white placeholder-slate-500 dark:placeholder-slate-400 transition-all duration-200 font-medium"
               maxlength="200" />
        <p class="mt-2 text-xs text-slate-500 dark:text-slate-500">
          Keep it concise but descriptive. This will be visible in agent inboxes.
        </p>
      </div>

      <!-- Body -->
      <div class="mb-6">
        <label for="body" class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">
          Message Body <span class="text-danger-500">*</span>
        </label>
        <textarea id="body"
                  x-model="body"
                  required
                  rows="12"
                  placeholder="Write your message here using Markdown...

Example:
# Action Required

Please investigate the following issue:

- Check database connections
- Review error logs from the last hour
- Report back with findings

**Deadline:** End of day today

Let me know if you need any clarification."
                  class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-900 border-2 border-slate-200 dark:border-slate-700 focus:border-primary-500 dark:focus:border-primary-500 rounded-xl text-slate-900 dark:text-white placeholder-slate-500 dark:placeholder-slate-400 transition-all duration-200 font-mono text-sm"></textarea>
        <p class="mt-2 text-xs text-slate-500 dark:text-slate-500">
          Supports GitHub-flavored Markdown: **bold**, *italic*, `code`, lists, links, etc.
        </p>
      </div>

      <!-- Thread ID (Optional) -->
      <div class="mb-6">
        <label for="threadId" class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">
          Thread ID <span class="text-slate-500 dark:text-slate-500 font-normal">(Optional)</span>
        </label>
        <input type="text"
               id="threadId"
               x-model="threadId"
               placeholder="e.g., 42 or custom-thread-id"
               class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-900 border-2 border-slate-200 dark:border-slate-700 focus:border-primary-500 dark:focus:border-primary-500 rounded-xl text-slate-900 dark:text-white placeholder-slate-500 dark:placeholder-slate-400 transition-all duration-200 font-mono" />
        <p class="mt-2 text-xs text-slate-500 dark:text-slate-500">
          Leave blank to start a new conversation. Provide an ID to continue an existing thread.
        </p>
      </div>

      <!-- Preamble Preview -->
      <div class="bg-gradient-to-br from-amber-50 to-orange-50 dark:from-amber-900/10 dark:to-orange-900/10 rounded-xl p-6 border-2 border-amber-300 dark:border-amber-700">
        <div class="flex items-start gap-3 mb-4">
          <i data-lucide="eye" class="w-5 h-5 text-amber-700 dark:text-amber-400 flex-shrink-0 mt-1"></i>
          <div>
            <h3 class="font-bold text-amber-900 dark:text-amber-100 mb-2">Automatic Preamble Preview</h3>
            <p class="text-sm text-amber-800 dark:text-amber-200">
              This preamble will be automatically added to the beginning of your message:
            </p>
          </div>
        </div>
        <div class="bg-white dark:bg-slate-800 rounded-lg p-4 border border-amber-200 dark:border-amber-800">
          <div class="prose prose-sm dark:prose-invert max-w-none">
            <div class="text-amber-900 dark:text-amber-100 font-medium text-center mb-3 pb-3 border-b-2 border-amber-300 dark:border-amber-700">
              ðŸš¨ MESSAGE FROM HUMAN OVERSEER ðŸš¨
            </div>
            <p class="text-slate-700 dark:text-slate-300 text-sm leading-relaxed">
              This message is from a human operator overseeing this project. <strong>Please prioritize the instructions below over your current tasks.</strong>
            </p>
            <p class="text-slate-700 dark:text-slate-300 text-sm leading-relaxed">
              You should:
            </p>
            <ol class="text-slate-700 dark:text-slate-300 text-sm">
              <li>Temporarily pause your current work</li>
              <li>Complete the request described below</li>
              <li>Resume your original plans afterward (unless modified by these instructions)</li>
            </ol>
            <p class="text-slate-700 dark:text-slate-300 text-sm leading-relaxed">
              <strong>The human's guidance supersedes all other priorities.</strong>
            </p>
            <hr class="my-3 border-amber-300 dark:border-amber-700">
          </div>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="flex items-center justify-between gap-4">
      <a href="/mail/{{ project.slug }}"
         class="px-6 py-3 text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors flex items-center gap-2 font-medium">
        <i data-lucide="arrow-left" class="w-4 h-4"></i>
        Cancel
      </a>

      <button type="submit"
              :disabled="!canSend()"
              class="px-8 py-4 bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-3 btn-ripple">
        <i data-lucide="send" class="w-5 h-5"></i>
        <span x-text="sending ? 'Sending...' : 'Send Message to ' + selectedRecipients.length + ' Agent' + (selectedRecipients.length !== 1 ? 's' : '')">Send Message</span>
      </button>
    </div>
  </form>

  <!-- Success/Error Toast -->
  <template x-if="showToast">
    <div x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform translate-y-2"
         x-transition:enter-end="opacity-100 transform translate-y-0"
         class="fixed bottom-6 right-6 z-50 max-w-md">
      <div :class="toastType === 'success' ? 'bg-success-600' : 'bg-danger-600'"
           class="rounded-xl p-4 shadow-2xl text-white flex items-start gap-3">
        <i :data-lucide="toastType === 'success' ? 'check-circle' : 'alert-circle'" class="w-6 h-6 flex-shrink-0"></i>
        <div class="flex-1">
          <h4 class="font-bold mb-1" x-text="toastTitle"></h4>
          <p class="text-sm opacity-90" x-text="toastMessage"></p>
        </div>
        <button @click="showToast = false" class="text-white/80 hover:text-white">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
    </div>
  </template>
</div>

<script>
function overseerComposer() {
  return {
    selectedRecipients: [],
    subject: '',
    body: '',
    threadId: '',
    sending: false,
    showToast: false,
    toastType: 'success',
    toastTitle: '',
    toastMessage: '',

    selectAll() {
      this.selectedRecipients = [{% for agent in agents %}{{ agent.name | tojson }}{% if not loop.last %}, {% endif %}{% endfor %}];
    },

    selectNone() {
      this.selectedRecipients = [];
    },

    canSend() {
      return this.selectedRecipients.length > 0 && this.subject.trim() && this.body.trim() && !this.sending;
    },

    async sendMessage() {
      if (!this.canSend()) return;

      this.sending = true;

      try {
        const response = await fetch('/mail/{{ project.slug }}/overseer/send', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            recipients: this.selectedRecipients,
            subject: this.subject.trim(),
            body_md: this.body.trim(),
            thread_id: this.threadId.trim() || null,
          })
        });

        if (!response.ok) {
          const error = await response.json().catch(() => ({}));
          throw new Error(error.detail || error.error || `Server error: ${response.status}`);
        }

        const result = await response.json();

        // Show success toast
        this.toastType = 'success';
        this.toastTitle = 'Message Sent!';
        this.toastMessage = `Successfully sent to ${this.selectedRecipients.length} agent${this.selectedRecipients.length !== 1 ? 's' : ''}`;
        this.showToast = true;

        // Redirect after 2 seconds
        setTimeout(() => {
          window.location.href = '/mail/{{ project.slug }}';
        }, 2000);

      } catch (error) {
        console.error('Failed to send message:', error);

        // Show error toast
        this.toastType = 'error';
        this.toastTitle = 'Failed to Send';
        this.toastMessage = error.message || 'An unexpected error occurred';
        this.showToast = true;

        this.sending = false;

        // Auto-hide error toast after 5 seconds
        setTimeout(() => {
          this.showToast = false;
        }, 5000);
      } finally {
        // Re-render lucide icons for toast (defensive check for lucide availability)
        if (typeof lucide !== 'undefined') {
          try {
            lucide.createIcons();
          } catch (iconError) {
            console.warn('Failed to render icons:', iconError);
          }
        }
      }
    }
  };
}
</script>
{% endblock %}
